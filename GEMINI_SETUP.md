# Настройка Gemini API для Ayala AI

## Что было сделано

Интегрирован Google Gemini API для чатбота Ayala - AI психолога-консультанта SafePlace.

### Изменения в коде:

1. **backend/pom.xml** - добавлена зависимость Gson для работы с JSON
2. **backend/src/main/java/com/safeplace/service/GeminiService.java** - новый сервис для работы с Gemini API
3. **backend/src/main/java/com/safeplace/service/MessageService.java** - интеграция автоматических ответов от Ayala
4. **backend/src/main/resources/application.properties** - добавлена конфигурация Gemini API
5. **docker-compose.yml** - добавлена переменная окружения для API ключа

## Как настроить API ключ

### Шаг 1: Получите API ключ Gemini

1. Перейдите на https://makersuite.google.com/app/apikey
2. Войдите с вашим Google аккаунтом
3. Нажмите "Create API Key"
4. Скопируйте созданный ключ

### Шаг 2: Настройте переменную окружения

#### Для Docker (Рекомендуется)

1. Создайте файл `.env` в корне проекта:
```bash
cp .env.example .env
```

2. Откройте `.env` и вставьте ваш API ключ:
```
GEMINI_API_KEY=ВАШ_API_КЛЮЧ_ЗДЕСЬ
```

3. Перезапустите Docker контейнеры:
```bash
docker-compose down
docker-compose up -d --build
```

#### Для локальной разработки

Установите переменную окружения перед запуском:

**Linux/Mac:**
```bash
export GEMINI_API_KEY=ВАШ_API_КЛЮЧ_ЗДЕСЬ
cd backend
./mvnw spring-boot:run
```

**Windows (PowerShell):**
```powershell
$env:GEMINI_API_KEY="ВАШ_API_КЛЮЧ_ЗДЕСЬ"
cd backend
.\mvnw spring-boot:run
```

**Windows (CMD):**
```cmd
set GEMINI_API_KEY=ВАШ_API_КЛЮЧ_ЗДЕСЬ
cd backend
mvnw spring-boot:run
```

## Как это работает

1. Пользователь открывает чат с Ayala AI (через интерфейс "Помощь" или напрямую)
2. Пользователь отправляет сообщение
3. MessageService автоматически определяет, что это чат с Ayala
4. GeminiService отправляет сообщение в Gemini API с контекстом психолога-консультанта
5. Ответ от AI сохраняется как сообщение от Ayala
6. Пользователь видит ответ в режиме реального времени

## Особенности реализации

- **Системный промпт**: Ayala настроена как эмпатичный AI психолог-консультант
- **Безопасность**: API ключ хранится в переменных окружения, не в коде
- **Fallback**: Если API недоступен, бот отправляет резервное сообщение
- **Асинхронность**: Ответы генерируются после отправки сообщения пользователя
- **Логирование**: Все запросы и ошибки логируются для отладки

## Проверка работы

1. Запустите приложение
2. Войдите в систему
3. Перейдите в раздел "Помощь" или "Сообщения"
4. Создайте чат с Ayala AI
5. Отправьте сообщение
6. В течение нескольких секунд вы должны получить ответ от AI

## Лимиты API

Gemini API имеет бесплатные лимиты:
- 60 запросов в минуту
- 1,500 запросов в день (для бесплатного уровня)

Для производственного использования рекомендуется:
- Настроить платный план
- Добавить rate limiting
- Реализовать кеширование ответов

## Безопасность

⚠️ **ВАЖНО**:
- НЕ коммитьте файл `.env` в git (он уже добавлен в .gitignore)
- НЕ публикуйте API ключ в коде или документации
- Используйте разные ключи для разработки и продакшена
- Регулярно ротируйте API ключи

## Troubleshooting

### Ошибка: "Gemini API error: 400"
- Проверьте правильность API ключа
- Убедитесь, что ключ активен в Google Cloud Console

### Ошибка: "Gemini API error: 429"
- Превышен лимит запросов
- Подождите или обновите план API

### Ayala не отвечает
- Проверьте логи: `docker-compose logs backend`
- Убедитесь, что переменная GEMINI_API_KEY установлена
- Проверьте подключение к интернету

### Используется fallback ответ
- API временно недоступен или ключ неправильный
- Проверьте логи для деталей ошибки
